<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Child Care Eligibility Calculator | OCC Project</title>
  <!--
    This site re-creates the functionality of the Operation Child Care Project
    calculator while adopting the look and feel of the OCC Project theme. It
    uses local JSON data derived from the provided Excel workbook to power
    the eligibility logic. All interactions and styling are implemented with
    vanilla JavaScript and CSS for broad compatibility. This is a single-file
    version with all CSS and JavaScript embedded.
  -->
  <style>
    /*
      Global Styles for the OCC Project Child Care Eligibility Calculator
    
      The palette draws inspiration from the OCC Project website, using a warm
      golden tone for primary elements, a deep navy for headings and text, and
      vibrant purple/red accents for call-to-action buttons. Layouts are
      responsive and mobile friendly.
    */

    :root {
      --primary-color: #e1b344;
      --secondary-color: #10395b;
      --accent-purple: #8f63d2;
      --accent-red: #e2453b;
      --background: #f7f4ef;
      --white: #ffffff;
      --gray: #f2f2f2;
      --text: #333333;
    }

    /* Utility class to hide steps until they are ready */
    .hidden-step, .hidden {
      display: none;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
      font-size: 16px;
    }

    header {
      background: var(--primary-color);
      color: var(--secondary-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
    }

    header .page-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--secondary-color);
    }

    .desktop-nav {
      display: none; /* Hidden by default, shown on larger screens */
    }

    /* Mobile menu toggle button */
    .menu-toggle {
      display: block; /* Shown by default, hidden on larger screens */
      font-size: 1.8rem;
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
    }

    /* Full-screen navigation overlay */
    .nav-overlay {
      height: 100%;
      width: 0; /* Start with 0 width */
      position: fixed;
      z-index: 1001;
      top: 0;
      left: 0;
      background-color: rgba(16, 57, 91, 0.98);
      overflow-x: hidden; /* Prevent horizontal scroll */
      transition: 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .nav-overlay-content {
      position: relative;
      width: 100%;
      text-align: center;
    }

    .nav-overlay a {
      padding: 1rem;
      text-decoration: none;
      font-size: 1.75rem;
      color: var(--white);
      display: block;
      transition: 0.3s;
    }

    .nav-overlay a:hover, .nav-overlay a:focus {
      color: var(--primary-color);
    }
    
    .nav-overlay .btn {
        border: 2px solid var(--white);
        margin: 0.5rem auto;
        width: 80%;
        max-width: 250px;
        border-radius: 25px;
    }
    
    .nav-overlay .btn.donate {
        background: var(--accent-purple);
        border-color: var(--accent-purple);
    }
    
    .nav-overlay .btn.contact {
        background: var(--accent-red);
        border-color: var(--accent-red);
    }

    .nav-overlay .close-nav {
      position: absolute;
      top: 20px;
      right: 45px;
      font-size: 40px;
      color: var(--white);
      background: none;
      border: none;
      cursor: pointer;
    }

    /* Hero section */
    .hero {
      position: relative;
      height: 40vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
      background-image: url("https://images.unsplash.com/photo-1576092762791-ddc29a261435?q=80&w=2070&auto=format&fit=crop");
      background-size: cover;
      background-position: center;
    }

    .hero .overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(16, 57, 91, 0.6);
    }

    .hero-content {
      position: relative;
      z-index: 1;
      color: var(--white);
      padding: 1rem;
    }

    .hero .hero-tagline {
      font-size: 1.5rem;
      font-weight: 600;
      max-width: 90%;
      margin: 0 auto;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    /* Calculator section */
    .calculator {
      max-width: 900px;
      margin: -3rem auto 2rem;
      padding: 1.5rem;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 2;
    }

    .calculator h2 {
      color: var(--secondary-color);
      margin-bottom: 1rem;
      font-size: 1.8rem;
      text-align: center;
    }
    
    .calculator .intro {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--secondary-color);
    }

    .form-group input[type="text"],
    .form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid var(--gray);
      border-radius: 4px;
      font-size: 1rem;
      background: var(--gray);
      transition: all 0.2s ease-in-out;
    }
    
    .form-group input[type="text"]:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        background: var(--white);
        box-shadow: 0 0 0 3px rgba(225, 179, 68, 0.3);
    }

    .install-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .install-container .browse-btn {
      margin-left: 0.5rem;
      padding: 0.8rem 1rem;
      background: var(--secondary-color);
      color: var(--white);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .install-container .browse-btn:hover {
        background: #1a4a72;
    }

    .age-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .age-option {
      padding: 0.8rem;
      border: 2px solid var(--gray);
      background: var(--gray);
      color: var(--secondary-color);
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s ease-in-out;
    }

    .age-option.active,
    .age-option:hover {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 2rem;
    }

    .actions .btn {
      width: 100%;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      text-align: center;
      transition: all 0.2s;
    }

    .actions .help {
      background: var(--accent-purple);
      color: var(--white);
    }
    
    .actions .help:hover {
        filter: brightness(1.1);
    }

    .actions .primary {
      background: var(--secondary-color);
      color: var(--white);
      opacity: 0.5;
      cursor: not-allowed;
    }

    .actions .primary.enabled {
      opacity: 1;
      cursor: pointer;
    }
    .actions .primary.enabled:hover {
        background: #1a4a72;
    }

    /* Progress indicator */
    .progress {
      margin-bottom: 1.5rem;
    }
    .progress span {
      display: block;
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 0.3rem;
    }
    .progress .bar {
      background: var(--gray);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress .bar-fill {
      background: var(--primary-color);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Results section */
    .results {
      max-width: 900px;
      margin: 2rem auto;
      padding: 1.5rem;
    }

    .results h2 {
      color: var(--secondary-color);
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      text-align: center;
    }

    #results-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .program-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      background: var(--white);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }
    .program-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .program-card h3 {
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
      font-size: 1.4rem;
    }
    
    .program-card p {
      flex-grow: 1;
      margin-bottom: 1rem;
    }

    .program-card .links {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .program-card .links a {
      padding: 0.6rem 1rem;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      display: block;
      transition: filter 0.2s;
    }
    .program-card .links a:hover {
        filter: brightness(1.1);
    }

    .program-card .links .signup {
      background: var(--primary-color);
      color: var(--secondary-color);
    }

    .program-card .links .learn {
      background: var(--accent-purple);
      color: var(--white);
    }

    .program-card .links .estimate {
      background: var(--accent-red);
      color: var(--white);
    }

    .program-card .status-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
      align-self: flex-start;
    }
    .program-card .eligible-badge {
      background: #d1e7dd;
      color: #0f5132;
      border: 1px solid #badbcc;
    }
    .program-card .not-eligible-badge {
      background: #f8d7da;
      color: #842029;
      border: 1px solid #f5c2c7;
    }

    .program-card.not-eligible {
      background: #fafafa;
      border-color: #eee;
    }
    .program-card.not-eligible h3,
    .program-card.not-eligible p {
      color: #888;
    }
    .program-card .not-eligible-note {
      font-style: italic;
      color: var(--accent-red);
      margin-top: 0.5rem;
      font-size: 0.9em;
    }

    /* Modal styling */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1002;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .modal:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background: var(--white);
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      color: var(--secondary-color);
      position: relative;
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .modal:not(.hidden) .modal-content {
        transform: scale(1);
    }

    .modal-content .close {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      font-size: 2rem;
      cursor: pointer;
      color: #aaa;
      transition: color 0.2s;
    }
    .modal-content .close:hover {
        color: #333;
    }
    
    .modal-content h3 {
        margin-bottom: 1rem;
    }
    
    .modal-content ul {
        list-style-position: inside;
    }
    
    .modal-content li {
        margin-bottom: 0.5rem;
    }
    
    .modal-content a {
        color: var(--accent-purple);
    }
    
    #install-search {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 2px solid var(--primary-color);
        border-radius: 4px;
        font-size: 1rem;
        background: var(--gray);
        margin-bottom: 1rem;
    }
    
    .install-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--gray);
      border-radius: 4px;
    }
    .install-list .item {
      padding: 0.75rem 0.8rem;
      cursor: pointer;
      border-bottom: 1px solid var(--gray);
    }
    .install-list .item:last-child {
        border-bottom: none;
    }
    .install-list .item:hover {
      background: var(--primary-color);
      color: var(--secondary-color);
    }


    /* Responsive adjustments */
    @media (min-width: 768px) {
      body {
        font-size: 18px;
      }
      
      .menu-toggle, .nav-overlay {
        display: none;
      }

      .desktop-nav {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }
      
      header .page-title {
        font-size: 1.5rem;
      }

      .hero {
        height: 50vh;
      }

      .hero .hero-tagline {
        font-size: 2.2rem;
      }

      .calculator {
        padding: 2.5rem;
        margin-top: -5rem;
      }
      
      .calculator h2 {
          font-size: 2.2rem;
      }

      .actions {
        flex-direction: row;
        justify-content: space-between;
      }

      .actions .btn {
        width: auto;
      }

      #results-container {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
      
      .program-card .links {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 class="page-title">Child Care Eligibility Calculator</h1>
      <button class="menu-toggle" aria-label="Open navigation menu">
        &#9776; <!-- Hamburger Icon -->
      </button>
      <nav class="desktop-nav">
        <!-- Desktop navigation links can be placed here if needed -->
      </nav>
    </div>
    <!-- Full-screen mobile navigation overlay -->
    <div id="mobile-nav-overlay" class="nav-overlay">
      <button class="close-nav">&times;</button>
      <div class="nav-overlay-content">
        <a href="#calculator">Calculator</a>
        <a href="#resources">Resources</a>
        <a href="#contact" class="btn contact">Contact</a>
        <a href="#donate" class="btn donate">Donate</a>
      </div>
    </div>
  </header>
  <main>
    <section id="home" class="hero">
      <div class="overlay"></div>
      <div class="hero-content">
        <p class="hero-tagline">Keeping the children safe for the ones who keep us safe</p>
      </div>
    </section>
    <section id="calculator" class="calculator">
      <h2>How It Works</h2>
      <p class="intro">
        Our child care eligibility calculator helps military families understand
        which programs they are eligible for based on their unique
        circumstances. Enter your details below to find out!
      </p>
      <!-- progress indicator shows where the user is in the four-step process -->
      <div id="progress" class="progress">
        <span id="progress-text">Step 1 of 4</span>
        <div class="bar">
          <div class="bar-fill" id="progress-bar-fill" style="width: 0%;"></div>
        </div>
      </div>

      <form id="eligibility-form">
        <!-- Step 1: Installation selection -->
        <div id="step1-group" class="form-group">
          <label for="installation">Step 1 — Installation</label>
          <div class="install-container">
            <input type="text" id="installation" name="installation" placeholder="Start typing your installation..." list="installation-list" autocomplete="off" />
            <button type="button" id="browse-installations" class="browse-btn" title="Browse installations">Browse</button>
          </div>
          <datalist id="installation-list"></datalist>
        </div>
        <!-- Step 2: Military family type (hidden until step 1 complete) -->
        <div id="step2-group" class="form-group hidden-step">
          <label for="family-type">Step 2 — Military Family Type</label>
          <select id="family-type">
            <option value="">Select a family type...</option>
          </select>
        </div>
        <!-- Step 3: Branch (hidden until step 2 complete) -->
        <div id="step3-group" class="form-group hidden-step">
          <label for="branch">Step 3 — Branch</label>
          <select id="branch">
            <option value="">Select branch...</option>
          </select>
        </div>
        <!-- Step 4: Child age (hidden until step 3 complete) -->
        <div id="step4-group" class="form-group age-group hidden-step">
          <label>Step 4 — Is your child school-aged (6 years or older)?</label>
          <div class="age-buttons">
            <button type="button" class="age-option" data-value="Yes">Yes</button>
            <button type="button" class="age-option" data-value="No">No</button>
          </div>
        </div>
        <div class="actions">
          <button type="button" id="need-help" class="btn help" type="button">Need Help?</button>
          <button type="submit" id="see-results" class="btn primary" disabled>See Results</button>
        </div>
      </form>
    </section>
    <section id="results" class="results hidden">
      <h2>Your Eligibility Results</h2>
      <div id="results-container"></div>
    </section>
  </main>
  <!-- Modal for help content -->
  <div id="help-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Need Help?</h3>
      <p>
        If you have questions about the eligibility calculator or need
        assistance applying for programs, please reach out to our team:
      </p>
      <ul>
        <li>Email: <a href="mailto:info@occproject.org">info@occproject.org</a></li>
        <li>Phone: <a href="tel:1-800-123-4567">(800) 123-4567</a></li>
        <li>Visit our <a href="#resources">resources</a> for more information.</li>
      </ul>
    </div>
  </div>

  <!-- Modal for browsing all installations -->
  <div id="install-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Your Installation</h3>
      <input type="text" id="install-search" placeholder="Search installations..." />
      <div id="install-list" class="install-list"></div>
    </div>
  </div>
  
  <script>
    /*
     * Core logic for the OCC Project eligibility calculator.
     *
     * This module loads locally stored JSON data (generated from the provided
     * spreadsheet), populates the form controls, listens for user input, and
     * computes program eligibility based on a simple set of rules. It also
     * manages the UI state of the form, results display, and help modal.
     */
    
    // --- DATA DEFINITIONS ---
    // Normally this would be in a separate data/data.js file
    
    const installations = [
        { Installation: "Fort Belvoir", State: "VA", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "eligible" },
        { Installation: "Quantico", State: "VA", MCCYN: "eligible", "MCCYN_PLUS": "ineligible", "EFMP/Respite": "eligible" },
        { Installation: "Naval Base Norfolk", State: "VA", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "eligible" },
        { Installation: "Fort Liberty", State: "NC", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "ineligible" },
        { Installation: "Camp Pendleton", State: "CA", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "eligible" }
    ];

    const familyTypes = [
        { military_family_type: "Active Duty", branch_of_service: "Army", school_age: "No", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "eligible" },
        { military_family_type: "Active Duty", branch_of_service: "Army", school_age: "Yes", MCCYN: "eligible", "MCCYN_PLUS": "ineligible", "EFMP/Respite": "eligible" },
        { military_family_type: "Active Duty", branch_of_service: "Marine Corps", school_age: "No", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "eligible" },
        { military_family_type: "Active Duty", branch_of_service: "Marine Corps", school_age: "Yes", MCCYN: "eligible", "MCCYN_PLUS": "ineligible", "EFMP/Respite": "eligible" },
        { military_family_type: "Active Duty", branch_of_service: "Navy", school_age: "No", MCCYN: "eligible", "MCCYN_PLUS": "eligible", "EFMP/Respite": "eligible" },
        { military_family_type: "Active Duty", branch_of_service: "Navy", school_age: "Yes", MCCYN: "eligible", "MCCYN_PLUS": "ineligible", "EFMP/Respite": "eligible" },
        { military_family_type: "Veteran", branch_of_service: "", school_age: "", MCCYN: "ineligible", "MCCYN_PLUS": "ineligible", "EFMP/Respite": "ineligible" }
    ];

    const programs = [
        { "Program Type": "MCCYN", Description: "Military Child Care in Your Neighborhood provides fee assistance for families who cannot access on-installation child care.", "Sign Up URL": "#", "Learn More URL": "#", "Estimate Subsidy URL": "#" },
        { "Program Type": "MCCYN_PLUS", Description: "An expansion of the MCCYN program for specific locations and circumstances.", "Sign Up URL": "#", "Learn More URL": "#", "Estimate Subsidy URL": null },
        { "Program Type": "EFMP/Respite", Description: "Respite care for families with children who have special needs (EFMP-enrolled).", "Sign Up URL": "#", "Learn More URL": "#", "Estimate Subsidy URL": null }
    ];

    const branches = ["Army", "Marine Corps", "Navy", "Air Force", "Space Force", "Coast Guard"];
    
    const masterFamilies = ["Active Duty", "Reservist", "Veteran", "DoD Civilian"];

    // --- END DATA DEFINITIONS ---

    document.addEventListener('DOMContentLoaded', () => {
      // DOM references
      const instField = document.getElementById('installation');
      const instListElement = document.getElementById('installation-list');
      const browseInstallationsBtn = document.getElementById('browse-installations');
      const installModal = document.getElementById('install-modal');
      const installModalClose = installModal.querySelector('.close');
      const installSearch = document.getElementById('install-search');
      const installListContainer = document.getElementById('install-list');
      const familySelect = document.getElementById('family-type');
      const branchSelect = document.getElementById('branch');
      const seeButton = document.getElementById('see-results');
      const helpButton = document.getElementById('need-help');
      const helpModal = document.getElementById('help-modal');
      const helpModalClose = helpModal.querySelector('.close');
      const ageButtons = document.querySelectorAll('.age-option');
      const resultsSection = document.getElementById('results');
      const resultsContainer = document.getElementById('results-container');

      // Step container references for progressive disclosure
      const step2Group = document.getElementById('step2-group');
      const step3Group = document.getElementById('step3-group');
      const step4Group = document.getElementById('step4-group');

      // Mobile menu toggle
      const menuToggle = document.querySelector('.menu-toggle');
      const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
      const closeNavBtn = document.querySelector('.close-nav');

      // Internal state variables
      let selectedInstallation = '';
      let selectedFamily = '';
      let selectedBranch = '';
      let selectedAge = '';

      // Helper to normalise strings for comparison
      const norm = (str) => (str || '').toString().trim().toLowerCase();

      // Populate installation datalist for typeahead suggestions
      function populateInstallationDatalist() {
        installations.forEach((inst) => {
          const option = document.createElement('option');
          option.value = `${inst.Installation} (${inst.State})`;
          option.dataset.name = inst.Installation;
          instListElement.appendChild(option);
        });
      }
      populateInstallationDatalist();

      // Populate family type dropdown
      masterFamilies.forEach((ft) => {
        const opt = document.createElement('option');
        opt.value = ft;
        opt.textContent = ft;
        familySelect.appendChild(opt);
      });

      // Populate branch dropdown
      branches.forEach((br) => {
        const opt = document.createElement('option');
        opt.value = br;
        opt.textContent = br;
        branchSelect.appendChild(opt);
      });

      // Update the state of the See Results button
      function updateButtonState() {
        const allFilled = selectedInstallation && selectedFamily && selectedBranch && selectedAge;
        seeButton.disabled = !allFilled;
        seeButton.classList.toggle('enabled', allFilled);
        updateProgressIndicator();
        updateStepVisibility();
      }

      // Update progress indicator based on the number of completed fields
      function updateProgressIndicator() {
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar-fill');
        let completed = [selectedInstallation, selectedFamily, selectedBranch, selectedAge].filter(Boolean).length;
        const nextStep = Math.min(completed + 1, 4);
        progressText.textContent = `Step ${nextStep} of 4`;
        progressBar.style.width = (completed / 4) * 100 + '%';
      }

      // Show or hide subsequent steps
      function updateStepVisibility() {
        step2Group.classList.toggle('hidden-step', !selectedInstallation);
        step3Group.classList.toggle('hidden-step', !selectedFamily);
        step4Group.classList.toggle('hidden-step', !selectedBranch);
      }

      // Installation input handler
      instField.addEventListener('input', (e) => {
        const value = e.target.value.trim();
        const name = value.includes('(') ? value.split('(')[0].trim() : value;
        const match = installations.find((inst) => norm(inst.Installation) === norm(name));
        selectedInstallation = match ? match.Installation : '';
        updateButtonState();
      });

      // Browse installations modal
      browseInstallationsBtn.addEventListener('click', () => {
        buildInstallModalList(installations);
        installModal.classList.remove('hidden');
        installSearch.value = '';
        installSearch.focus();
      });

      function buildInstallModalList(list) {
        installListContainer.innerHTML = '';
        list.forEach((inst) => {
          const item = document.createElement('div');
          item.className = 'item';
          item.textContent = `${inst.Installation} (${inst.State})`;
          item.addEventListener('click', () => {
            instField.value = `${inst.Installation} (${inst.State})`;
            selectedInstallation = inst.Installation;
            installModal.classList.add('hidden');
            updateButtonState();
          });
          installListContainer.appendChild(item);
        });
      }

      installSearch.addEventListener('input', () => {
        const value = installSearch.value.trim();
        const filtered = installations.filter((inst) =>
          norm(inst.Installation).includes(norm(value)) || norm(inst.State).includes(norm(value))
        );
        buildInstallModalList(filtered);
      });

      function closeModal(modal) {
        modal.classList.add('hidden');
      }

      installModalClose.addEventListener('click', () => closeModal(installModal));
      installModal.addEventListener('click', (e) => {
        if (e.target === installModal) closeModal(installModal);
      });

      // Form selections
      familySelect.addEventListener('change', (e) => {
        selectedFamily = e.target.value;
        updateButtonState();
      });

      branchSelect.addEventListener('change', (e) => {
        selectedBranch = e.target.value;
        updateButtonState();
      });

      ageButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          ageButtons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          selectedAge = btn.dataset.value;
          updateButtonState();
        });
      });

      // Modal open/close handlers
      helpButton.addEventListener('click', () => helpModal.classList.remove('hidden'));
      helpModalClose.addEventListener('click', () => closeModal(helpModal));
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) closeModal(helpModal);
      });

      // Compute eligibility status for every program
      function computeEligibilityStatus(installationName, familyType, branch, age) {
        // 1. Find the selected installation, or null if not found.
        const installation = installations.find(
          (inst) => norm(inst.Installation) === norm(installationName)
        );

        // 2. Find all matching family type rules.
        const matchingFamilyRules = familyTypes.filter((rule) => {
          const familyMatch = norm(rule.military_family_type) === norm(familyType);
          // Rule applies to all branches if its branch is empty
          const branchMatch = !rule.branch_of_service || norm(rule.branch_of_service) === norm(branch);
          // Rule applies to all ages if its age is empty
          const ageMatch = !rule.school_age || norm(rule.school_age) === norm(age);
          return familyMatch && branchMatch && ageMatch;
        });

        // 3. Iterate over EVERY program and determine its status. This ensures all tiles are always processed.
        const statuses = programs.map((program) => {
          const programKey = program['Program Type']; // This is the key used in the data objects, e.g., "MCCYN_PLUS"

          // 3a. Check installation eligibility.
          // It's eligible if the installation was found and its key for this program is 'eligible'.
          const isEligibleAtInstallation = 
            installation && 
            installation[programKey] && 
            norm(installation[programKey]) === 'eligible';

          // 3b. Check family eligibility.
          // If there are no specific family rules, treat the program as open to all.
          const isEligibleForFamily =
            matchingFamilyRules.length === 0 ||
            matchingFamilyRules.some(
              (rule) => rule[programKey] && norm(rule[programKey]) === 'eligible'
            );

          // The final eligibility is a combination of both installation and family checks.
          return {
            program: program,
            eligible: isEligibleAtInstallation && isEligibleForFamily,
          };
        });

        return statuses;
      }


      // Render eligibility results
      function renderEligibilityResults(statuses) {
        resultsContainer.innerHTML = '';
        if (!statuses || statuses.length === 0) {
          resultsContainer.innerHTML = '<p>Unfortunately, there are no programs to display at this time.</p>';
          return;
        }
        statuses.forEach(({ program, eligible }) => {
          const card = document.createElement('div');
          card.className = `program-card ${eligible ? '' : 'not-eligible'}`;
          
          let linksHtml = '';
          if (eligible) {
              if (program['Sign Up URL']) linksHtml += `<a href="${program['Sign Up URL']}" target="_blank" rel="noopener noreferrer" class="signup">Sign Up</a>`;
              if (program['Learn More URL']) linksHtml += `<a href="${program['Learn More URL']}" target="_blank" rel="noopener noreferrer" class="learn">Learn More</a>`;
              if (program['Estimate Subsidy URL']) linksHtml += `<a href="${program['Estimate Subsidy URL']}" target="_blank" rel="noopener noreferrer" class="estimate">Estimate Subsidy</a>`;
          } else {
              linksHtml += `<p class="not-eligible-note">You do not currently qualify for this program.</p>`;
              if (program['Learn More URL']) linksHtml += `<a href="${program['Learn More URL']}" target="_blank" rel="noopener noreferrer" class="learn">Learn More</a>`;
          }

          card.innerHTML = `
            <span class="status-badge ${eligible ? 'eligible-badge' : 'not-eligible-badge'}">${eligible ? 'Eligible' : 'Not Eligible'}</span>
            <h3>${program['Program Type'].replace('_', '-')}</h3>
            <p>${program['Description'] || 'No description available.'}</p>
            <div class="links">${linksHtml}</div>`;
          resultsContainer.appendChild(card);
        });
      }

      // Form submission handler
      document.getElementById('eligibility-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!selectedInstallation || !selectedFamily || !selectedBranch || !selectedAge) return;
        const statuses = computeEligibilityStatus(selectedInstallation, selectedFamily, selectedBranch, selectedAge);
        renderEligibilityResults(statuses);
        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth' });
      });
      
      // Mobile navigation toggle
      menuToggle.addEventListener('click', () => {
        mobileNavOverlay.style.width = '100%';
      });

      closeNavBtn.addEventListener('click', () => {
        mobileNavOverlay.style.width = '0';
      });

      // Initial state setup
      updateButtonState();
    });
  </script>
</body>
</html>
